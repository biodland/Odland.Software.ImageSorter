stages:
  - build
  - release

variables:
  DOTNET_CLI_TELEMETRY_OPTOUT: "1"
  DOTNET_NOLOGO: "1"

build:
  stage: build
  image: mcr.microsoft.com/dotnet/sdk:10.0
  before_script:
    - git fetch --tags
  script:
    - pwsh ./update-version.ps1
    - dotnet restore src/Odland.Software.ImageSorter/ImageSorter.csproj
    - dotnet build --configuration Release src/Odland.Software.ImageSorter/ImageSorter.csproj
    - dotnet publish --configuration Release --output publish src/Odland.Software.ImageSorter/ImageSorter.csproj
  artifacts:
    paths:
      - src/Odland.Software.ImageSorter/publish/
    expire_in: 1 week
  only:
    - main
    - tags

release:
  stage: release
  image: registry.gitlab.com/gitlab-org/release-cli:latest
  before_script:
    - git fetch --tags
  script:
    # Generate release notes from commit messages since last tag
    - |
      if [ -n "$CI_COMMIT_TAG" ]; then
        PREV_TAG=$(git describe --tags --abbrev=0 $CI_COMMIT_TAG^ 2>/dev/null || echo "")
        if [ -n "$PREV_TAG" ]; then
          git log $PREV_TAG..$CI_COMMIT_TAG --pretty=format:"* %s" > release-notes.md
        else
          git log $CI_COMMIT_TAG --pretty=format:"* %s" > release-notes.md
        fi
      else
        echo "No tag found, skipping release notes generation." > release-notes.md
      fi
    - cat release-notes.md
  rules:
    - if: $CI_COMMIT_TAG
  release:
    tag_name: $CI_COMMIT_TAG
    description: |
      $(cat release-notes.md)
    assets:
      links:
        - name: "Published Artifacts"
          url: "$CI_PROJECT_URL/-/jobs/$CI_JOB_ID/artifacts/download"
